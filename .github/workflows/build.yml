name: Build Imalink Desktop Installer

on:
  # Manual trigger from GitHub UI
  workflow_dispatch:
  
  # Automatic trigger on version tags
  push:
    tags:
      - 'v*'

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: 'ubuntu-22.04'
            target: 'x86_64-unknown-linux-gnu'
            os_name: 'linux'
          - platform: 'windows-latest'
            target: 'x86_64-pc-windows-msvc'
            os_name: 'windows'
          - platform: 'macos-latest'
            target: 'aarch64-apple-darwin'
            os_name: 'macos'

    runs-on: ${{ matrix.platform }}

    steps:
      - name: Checkout imalink-desktop
        uses: actions/checkout@v4
        with:
          path: imalink-desktop

      - name: Checkout imalink-core
        uses: actions/checkout@v4
        with:
          repository: kjelkols/imalink-core
          path: imalink-core

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install uv (Linux/macOS)
        if: matrix.os_name != 'windows'
        run: curl -LsSf https://astral.sh/uv/install.sh | sh

      - name: Install uv (Windows)
        if: matrix.os_name == 'windows'
        run: irm https://astral.sh/uv/install.ps1 | iex
        shell: powershell

      - name: Install Linux dependencies
        if: matrix.os_name == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.0-dev libgtk-3-dev libayatana-appindicator3-dev librsvg2-dev

      - name: Install npm dependencies
        working-directory: imalink-desktop
        run: npm install

      - name: Build imalink-core with PyInstaller
        working-directory: imalink-core
        shell: bash
        run: |
          uv pip install pyinstaller
          uv run pyinstaller --onefile --name imalink-core --add-data "src:src" service/main.py

      - name: Copy imalink-core binary to desktop (Linux/macOS)
        if: matrix.os_name != 'windows'
        shell: bash
        run: |
          mkdir -p imalink-desktop/src-tauri/binaries
          cp imalink-core/dist/imalink-core "imalink-desktop/src-tauri/binaries/imalink-core-${{ matrix.target }}"
          chmod +x "imalink-desktop/src-tauri/binaries/imalink-core-${{ matrix.target }}"

      - name: Copy imalink-core binary to desktop (Windows)
        if: matrix.os_name == 'windows'
        shell: bash
        run: |
          mkdir -p imalink-desktop/src-tauri/binaries
          cp imalink-core/dist/imalink-core.exe "imalink-desktop/src-tauri/binaries/imalink-core-${{ matrix.target }}.exe"

      - name: Build Tauri app
        working-directory: imalink-desktop
        run: npm run tauri build

      - name: Upload artifacts (Linux - deb)
        if: matrix.os_name == 'linux'
        uses: actions/upload-artifact@v4
        with:
          name: imalink-desktop-linux-deb
          path: imalink-desktop/src-tauri/target/release/bundle/deb/*.deb

      - name: Upload artifacts (Linux - AppImage)
        if: matrix.os_name == 'linux'
        uses: actions/upload-artifact@v4
        with:
          name: imalink-desktop-linux-appimage
          path: imalink-desktop/src-tauri/target/release/bundle/appimage/*.AppImage
        continue-on-error: true

      - name: Upload artifacts (Windows - msi)
        if: matrix.os_name == 'windows'
        uses: actions/upload-artifact@v4
        with:
          name: imalink-desktop-windows-msi
          path: imalink-desktop/src-tauri/target/release/bundle/msi/*.msi

      - name: Upload artifacts (Windows - exe)
        if: matrix.os_name == 'windows'
        uses: actions/upload-artifact@v4
        with:
          name: imalink-desktop-windows-nsis
          path: imalink-desktop/src-tauri/target/release/bundle/nsis/*.exe

      - name: Upload artifacts (macOS - dmg)
        if: matrix.os_name == 'macos'
        uses: actions/upload-artifact@v4
        with:
          name: imalink-desktop-macos-dmg
          path: imalink-desktop/src-tauri/target/release/bundle/dmg/*.dmg

      - name: Upload artifacts (macOS - app)
        if: matrix.os_name == 'macos'
        uses: actions/upload-artifact@v4
        with:
          name: imalink-desktop-macos-app
          path: imalink-desktop/src-tauri/target/release/bundle/macos/*.app

  # Create GitHub Release when triggered by tag
  release:
    if: startsWith(github.ref, 'refs/tags/')
    needs: build
    runs-on: ubuntu-latest
    
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            artifacts/**/*.deb
            artifacts/**/*.AppImage
            artifacts/**/*.msi
            artifacts/**/*.exe
            artifacts/**/*.dmg
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
